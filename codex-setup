#!/usr/bin/env bash

AGENTS_WORKFLOW_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"

# BEWARE! The heredoc below is intentially using long lines, becuase otherwise
# Codex gets confused sometimes by the terminal output in its environment that
# splits the lines in unexpected ways (Codex decides the file is truncated).

# Conditionally set the autopush flag based on GITHUB_TOKEN availability
if [ -n "${GITHUB_TOKEN}" ]; then
  GET_TASK_CMD="get-task --autopush"
else
  GET_TASK_CMD="get-task"
fi

# Configure ~/.netrc for Git hosting services
NETRC_CONTENT=""
if [ -n "${GITHUB_TOKEN}" ]; then
  NETRC_CONTENT+=$'machine github.com\n  login x-access-token\n  password '${GITHUB_TOKEN}$'\n'
fi
if [ -n "${GITLAB_TOKEN}" ]; then
  NETRC_CONTENT+=$'machine gitlab.com\n  login oauth2\n  password '${GITLAB_TOKEN}$'\n'
fi
if [ -n "${BITBUCKET_TOKEN}" ]; then
  NETRC_CONTENT+=$'machine bitbucket.org\n  login x-token-auth\n  password '${BITBUCKET_TOKEN}$'\n'
fi
if [ -n "$NETRC_CONTENT" ]; then
  echo "Configuring ~/.netrc for git authentication"
  printf "%s" "$NETRC_CONTENT" > "$HOME/.netrc"
  chmod 600 "$HOME/.netrc"
fi

cat > ../AGENTS.md << EOF
When you a given a task description or developer instructions that
just state "go", execute the shell command \`${GET_TASK_CMD}\` under
the repository root and follow the instructions provided in the output.

When the task description or developer instructions are not "go",
record them with the following command instead:

  start-work --branch-name <SHORT_NAME> --task-description "<message>" --autopush

For follow-up tasks, use:

  start-work --task-description "<message>" --autopush

The command automatically stores the task description and prepares the
repository for work.

After finishing a task, examine your changes and squash them in a single
commit that includes a summary of the work.

EOF

bash "$AGENTS_WORKFLOW_DIR/common-pre-setup"

if [ -f .agents/codex-setup ]; then
  .agents/codex-setup
fi

if [ -f .agents/common-post-setup ]; then
  .agents/common-post-setup
fi

bash "$AGENTS_WORKFLOW_DIR/common-post-setup"
